{
  "custom_summary": "Serverless Egress Control Alert",
  "evaluation": {
    "source": {
      "name": "network_events",
      "display": "network_events",
      "aggregation": "AGGREGATION_UNSPECIFIED"
    },
    "comparison_operator": "IS_NOT_NULL",
    "threshold": {
      "value": {
        "string_value": ""
      }
    },
    "empty_result_state": "OK",
    "notification": {
      "retrigger_seconds": 1,
      "notify_on_ok": true
    }
  },
  "schedule": {
    "quartz_cron_schedule": "58 0 7,15 * * ?",
    "timezone_id": "Europe/London"
  },
  "query_lines": [
    "-- Alert to check whether any serverless outbound network events have been denied (or dry run denied) within the last 24 hours ",
    "WITH network_events AS (SELECT",
    "to_date(event_time) AS event_date,",
    "workspace_id,",
    "network_source_type,",
    "access_type AS event_type,",
    "destination_type,",
    "destination,",
    "count(*) AS num_events",
    "FROM system.access.outbound_network",
    "WHERE event_time >= current_timestamp() - INTERVAL 12 MONTHS",
    "AND access_type IN ('DROP', 'DRY_RUN_DENIAL')",
    "GROUP BY ALL",
    "ORDER BY event_date DESC",
    "LIMIT 100),",
    "rows as (",
    "  SELECT array_agg(",
    "    '<tr><td>' || event_date || '</td><td>' || workspace_id || '</td><td>' || network_source_type || '</td><td>' || event_type || '</td><td>' || destination_type || '</td><td>' || destination || '</td><td>' || num_events || '</td></tr>') as rows_html",
    "  FROM network_events  ",
    ")",
    "",
    "SELECT '<table><tbody><tr><th style=\"width: 80px\">Event Date</th><th style=\"width: 80px\">Workspace Id</th><th style=\"width: 80px\">Network Source</th><th style=\"width: auto\">Event Type</th><th style=\"width: auto\">Destination Type</th><th style=\"width: 80px\">Destination</th><th style=\"width: 80px\">Number of Events</th></tr></tbody>\\n<tbody>' || array_join(rows_html, '\\n') || '</tbody></table>' as network_events",
    "FROM rows",
    "WHERE array_size(rows_html) > 0"
  ],
  "custom_description_lines": [
    "<h4>Unauthorised outbound network connections detected!</h4>",
    "",
    "⚠️⚠️ Alert \"{{ALERT_NAME}}\" changed status to {{ALERT_STATUS}} ⚠️⚠️",
    "<p></p>",
    "<h4>Network Events:</h4>",
    "<p></p>",
    "{{QUERY_RESULT_VALUE}}",
    "<p></p>",
    "Please refer to <a href=\"{{ALERT_URL}}\">the alert</a> for more information!"
  ]
}
